# Slash Command Contract: /tc.specify

**Command**: `/tc.specify`
**Purpose**: Generate technology-agnostic tc test suites from spec-kit specification documents
**Priority**: P1 (Foundation - User Story 1)

## Interface

### Command Syntax

```bash
/tc.specify [options]
```

### Options

| Flag | Type | Required | Default | Description |
|------|------|----------|---------|-------------|
| `--spec` | path | No | Auto-detect | Path to spec.md (defaults to current feature) |
| `--output` | path | No | `./tc/tests/` | Base directory for generated tests |
| `--dry-run` | boolean | No | false | Show what would be generated without creating files |
| `--force` | boolean | No | false | Overwrite existing tests (default: fail if exists) |
| `--verbose` | boolean | No | false | Show detailed generation progress |

### Arguments

None (command uses options only)

### Environment Variables

| Variable | Type | Description |
|----------|------|-------------|
| `TC_CUSTOM_PATTERNS` | string | Custom pattern definitions (pattern:regex, newline-separated) |
| `SPEC_DIR` | path | Override auto-detection of spec directory |

## Behavior

### Preconditions

1. Must be run from repository root or feature branch with `.specify/` structure
2. spec.md must exist and contain at least one user story
3. Target output directory must be writable
4. tc framework must be available (`bin/tc` or `tc` in PATH)

### Success Criteria (FR-001, FR-002, FR-003, FR-004, FR-005)

**Input**: spec.md with user stories and acceptance scenarios
**Output**: Generated tc test suites with:
- Directory structure: `tc/tests/{feature}/user-story-{NN}/scenario-{NN}/`
- Files per scenario:
  - `run` - Executable bash script (chmod +x, NOT_IMPLEMENTED template)
  - `data/input.json` - Test input (mapped from Given clause)
  - `data/expected.json` - Expected output with patterns (mapped from Then clause)
- Metadata: `tc/spec-kit/traceability.json` - Bidirectional spec↔test links

**Exit Codes**:
- `0` - Success (all tests generated)
- `1` - Fatal error (spec not found, no user stories, invalid spec)
- `2` - Partial success (some scenarios failed, see warnings)

### Algorithm

```
1. Auto-detect feature directory and spec.md path
   - If --spec provided: use explicit path
   - Else: Use git branch name to locate specs/{branch}/spec.md

2. Parse spec.md:
   - Extract user stories (grep "### User Story")
   - For each user story:
     - Extract title, priority, acceptance scenarios
     - For each scenario:
       - Parse Given/When/Then clauses
       - Identify pattern hints (keywords: UUID, timestamp, count, etc.)

3. Generate test structure:
   - Create directory: tc/tests/{feature}/user-story-{NN}/scenario-{NN}/
   - Generate input.json from Given clause (rule-based mapping)
   - Generate expected.json from Then clause (apply pattern heuristics)
   - Generate run script from template (NOT_IMPLEMENTED, includes spec ref)

4. Generate traceability.json:
   - Build forward map (spec → tests)
   - Build reverse map (tests → spec)
   - Write to tc/spec-kit/traceability.json

5. Generate maturity.json:
   - Initialize all tests at "concept" level
   - Record creation timestamp
   - Set signals.has_implementation = false

6. Report results:
   - Summary: X user stories, Y scenarios, Z tests generated
   - List generated test paths
   - Suggest next steps: "Run tests with: tc tc/tests/{feature} --all"
```

## Input/Output Examples

### Example 1: Basic Generation

**Input**:
```bash
/tc.specify
```

**spec.md** (excerpt):
```markdown
### User Story 1 - User Authentication (Priority: P1)

**Acceptance Scenarios**:

1. **Given** a valid username and password, **When** user submits login form, **Then** system returns authentication token with expiration timestamp
```

**Output** (file structure):
```
tc/tests/008-explore-the-strategy/
└── user-story-01/
    └── scenario-01/
        ├── run                 # Executable, returns NOT_IMPLEMENTED
        └── data/
            ├── input.json
            └── expected.json
```

**input.json**:
```json
{
  "username": "valid_user",
  "password": "valid_password"
}
```

**expected.json**:
```json
{
  "auth_token": "<uuid>",
  "expires_at": "<timestamp>"
}
```

**run** script:
```bash
#!/usr/bin/env bash
# Auto-generated by tc-kit from spec: specs/008-explore-the-strategy/spec.md
# User Story: User Authentication
# Scenario: 1
# Traceability: user-story-1.scenario-1

set -euo pipefail

input=$(cat)

echo '{"error": "NOT_IMPLEMENTED", "message": "Test runner not yet implemented"}' >&2
exit 1

# Expected behavior (from spec):
# Given: a valid username and password
# When: user submits login form
# Then: system returns authentication token with expiration timestamp
```

**Terminal Output**:
```
✓ Parsed spec: 1 user stories, 1 acceptance scenarios
✓ Generated 1 test scenarios
  - tc/tests/008-explore-the-strategy/user-story-01/scenario-01/

✓ Created traceability: tc/spec-kit/traceability.json
✓ Initialized maturity tracking: tc/spec-kit/maturity.json

Summary:
  User Stories: 1
  Scenarios: 1
  Tests Generated: 1
  Coverage: 100%

Next steps:
  Run tests: tc tc/tests/008-explore-the-strategy --all
  Refine tests: /tc.refine
```

### Example 2: Dry Run

**Input**:
```bash
/tc.specify --dry-run
```

**Output**:
```
[DRY RUN] Would generate the following tests:

  tc/tests/008-explore-the-strategy/user-story-01/scenario-01/
  tc/tests/008-explore-the-strategy/user-story-01/scenario-02/
  tc/tests/008-explore-the-strategy/user-story-02/scenario-01/

[DRY RUN] Would create:
  tc/spec-kit/traceability.json (3 mappings)
  tc/spec-kit/maturity.json (3 suites at concept level)

No files created (use --force to overwrite, or remove --dry-run to generate).
```

### Example 3: Partial Failure

**Input**:
```bash
/tc.specify
```

**Output** (with malformed scenario):
```
✓ Parsed spec: 2 user stories, 3 acceptance scenarios

⚠ WARNING: Failed to parse scenario 2 in user-story-1 (missing Then clause)
  Skipped: specs/008-explore-the-strategy/spec.md:45

✓ Generated 2 of 3 test scenarios
  - tc/tests/008-explore-the-strategy/user-story-01/scenario-01/
  - tc/tests/008-explore-the-strategy/user-story-02/scenario-01/

Summary:
  User Stories: 2
  Scenarios: 3
  Tests Generated: 2 (1 skipped)
  Coverage: 67%

Action required:
  Fix scenario at line 45 in spec.md (missing Then clause)
  Re-run: /tc.specify --force

Exit code: 2 (partial success)
```

## Error Handling

### Fatal Errors (Exit 1)

| Error | Condition | Message |
|-------|-----------|---------|
| Spec not found | spec.md doesn't exist | `ERROR: spec.md not found at {path}` |
| No user stories | No "### User Story" headers | `ERROR: No user stories found in spec` |
| Invalid output path | Output directory not writable | `ERROR: Cannot write to {path} (permission denied)` |
| Traceability corruption | Existing traceability.json malformed | `ERROR: Corrupted traceability.json (backup and delete to regenerate)` |

### Recoverable Errors (Exit 2, Partial Success)

| Error | Condition | Behavior |
|-------|-----------|----------|
| Malformed scenario | Missing Given/When/Then | Skip scenario, log warning, continue |
| Ambiguous criteria | Multiple interpretations possible | Generate all variants with suffixes, warn |
| Duplicate names | Same scenario name in user story | Append `-variant-N`, warn |

### Edge Cases

| Case | Behavior |
|------|----------|
| Empty spec | Generate empty traceability.json, warn user |
| Non-JSON-testable criteria (UI) | Generate placeholder with TODO comment |
| Pattern hints unclear | Default to `<string>` (most permissive) |
| Existing tests with --force | Backup to `.bak` before overwriting |

## Testing Contract

**TC Test Suite**: `tc/tests/tc-kit/tc-kit-specify/`

**Test Scenarios**:
1. **Basic generation**: Valid spec → generates all test files correctly
2. **Pattern mapping**: Keyword detection → correct pattern types in expected.json
3. **Traceability**: Generation → bidirectional links consistent
4. **Dry run**: --dry-run flag → no files created, correct preview
5. **Partial failure**: Malformed scenario → skip and continue
6. **Edge case - empty spec**: No user stories → warn and exit gracefully

## Dependencies

- **tc framework**: For pattern validation and test execution
- **jq**: For JSON generation and manipulation
- **grep/sed/awk**: For markdown parsing
- **git**: For branch detection (optional, can use --spec)

## Performance

**Target** (SC-001): <30 seconds for complete spec generation

**Benchmarks**:
- 5 user stories, 15 scenarios: <10 seconds
- 20 user stories, 60 scenarios: <30 seconds
- 50 user stories, 150 scenarios: <60 seconds (with warning)

## Related Requirements

- FR-001: Generate tc-compatible test suites
- FR-002: One test scenario per acceptance criteria
- FR-003: Generate input.json and expected.json with pattern syntax
- FR-004: Use technology-agnostic patterns by default
- FR-005: Create placeholder run scripts with NOT_IMPLEMENTED
- SC-001: Generation completes in <30 seconds
- SC-002: 90% mapping success rate
