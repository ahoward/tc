# Slash Command Contract: /tc.refine

**Command**: `/tc.refine`
**Purpose**: Incrementally refine abstract tests into technology-specific assertions while preserving behavioral intent
**Priority**: P2 (Progressive Refinement - User Story 2)

## Interface

### Command Syntax

```bash
/tc.refine [test-path] [options]
```

### Options

| Flag | Type | Required | Default | Description |
|------|------|----------|---------|-------------|
| `--level` | enum | No | Auto-detect | Force maturity level: concept/exploration/implementation |
| `--suite` | path | No | All suites | Refine specific test suite only |
| `--interactive` | boolean | No | false | Prompt for each refinement decision |
| `--suggest` | boolean | No | true | Show refinement suggestions without applying |
| `--apply` | boolean | No | false | Apply suggested refinements (requires confirmation) |
| `--dry-run` | boolean | No | false | Show changes without modifying files |

### Arguments

- `test-path` (optional): Path to specific test suite or scenario (defaults to all tests in current feature)

### Environment Variables

| Variable | Type | Description |
|----------|------|-------------|
| `TC_CUSTOM_PATTERNS` | string | Custom patterns to suggest in refinement |
| `GIT_AUTHOR_EMAIL` | string | Used to detect first implementation commit |

## Behavior

### Preconditions

1. Test suites must exist (generated by `/tc.specify`)
2. `tc/spec-kit/maturity.json` must exist
3. `tc/spec-kit/traceability.json` must exist
4. Git repository (optional, for signal detection)

### Success Criteria (FR-006, FR-007, FR-008, FR-009, FR-010)

**Input**: Existing test suites with maturity tracking
**Output**:
- Updated tests with refined patterns/values
- Preserved original pattern-based tests (as baseline variants)
- Updated maturity levels in `tc/spec-kit/maturity.json`
- Refactoring suggestions logged

**Exit Codes**:
- `0` - Success (refinements suggested or applied)
- `1` - Fatal error (no tests found, corrupted metadata)
- `2` - Warnings (conflicting refinements, over-specification detected)

### Algorithm

```
1. Load maturity metadata:
   - Read tc/spec-kit/maturity.json
   - Read tc/spec-kit/traceability.json

2. Detect maturity signals for each test suite:
   - Check run script modification (git log or mtime)
   - Count consecutive passing runs (from tc results)
   - Analyze pattern usage in expected.json
   - Determine suggested maturity level

3. Generate refinement suggestions:
   - For concept ‚Üí exploration:
     - Suggest adding concrete values for known patterns
     - Suggest implementing run script logic
   - For exploration ‚Üí implementation:
     - Suggest replacing remaining patterns with exact values
     - Suggest adding custom assertions beyond JSON matching
   - Detect over-specification risks (too many exact values too early)

4. Apply refinements (if --apply flag):
   - Create baseline variant (preserve original as scenario-NN-baseline/)
   - Update expected.json with refined values/patterns
   - Update run script with implementation hints
   - Update maturity.json with new level and signals

5. Report results:
   - Summary: X tests analyzed, Y refinements suggested
   - Maturity transitions: Z tests promoted to next level
   - Warnings: Over-specification detected in A tests
```

## Input/Output Examples

### Example 1: Suggest Refinements

**Input**:
```bash
/tc.refine --suggest
```

**maturity.json** (before):
```json
{
  "suites": {
    "tc/tests/008-explore-the-strategy/user-story-01/scenario-01": {
      "maturity_level": "concept",
      "detected_signals": {
        "has_implementation": false,
        "passing_runs": 0,
        "pattern_types": ["<uuid>", "<timestamp>"]
      }
    }
  }
}
```

**Terminal Output**:
```
üîç Analyzing test maturity signals...

Suite: tc/tests/008-explore-the-strategy/user-story-01/scenario-01
  Current Level: concept
  Detected Signals:
    ‚úó No implementation (run script unchanged)
    ‚úó No passing runs (0 executions)
    ‚úì Pure patterns (<uuid>, <timestamp>)

  Suggested Level: concept (no change)

  Refinement Opportunities:
    1. Implement run script logic to move to exploration level
    2. Once implemented, consider refining patterns:
       - <uuid> ‚Üí concrete UUID if identity matters for test
       - <timestamp> ‚Üí relative time assertions (e.g., "within last 5min")

No automatic refinements available (suite still at concept level).

Next steps:
  1. Implement run script: edit tc/tests/.../scenario-01/run
  2. Run tests: tc tc/tests/008-explore-the-strategy --all
  3. Re-run refinement: /tc.refine --suggest
```

### Example 2: Apply Refinement (Concept ‚Üí Exploration)

**Input**:
```bash
/tc.refine --apply
```

**Scenario**: Run script has been implemented, tests are passing

**Terminal Output**:
```
üîç Analyzing test maturity signals...

Suite: tc/tests/008-explore-the-strategy/user-story-01/scenario-01
  Current Level: concept
  Detected Signals:
    ‚úì Implementation detected (run script modified 2h ago)
    ‚úì Passing runs: 3 consecutive
    ‚úì Patterns still abstract (<uuid>, <timestamp>)

  Suggested Level: exploration

Apply maturity transition concept ‚Üí exploration? [Y/n]: Y

‚úì Backed up original test: scenario-01-concept-baseline/
‚úì Updated maturity level: concept ‚Üí exploration
‚úì Recorded transition in maturity.json

Refinement suggestions for exploration level:
  1. Consider adding concrete UUID if user identity matters:
     Current: {"user_id": "<uuid>"}
     Suggestion: {"user_id": "550e8400-e29b-41d4-a716-446655440000"}

  2. Consider time-relative assertions for timestamps:
     Current: {"created_at": "<timestamp>"}
     Suggestion: Use tc custom pattern: "<timestamp_recent>" (within 5min)

Apply these refinements? [y/N]: N

Refinements skipped (manual refinement recommended).
```

### Example 3: Over-Specification Warning

**Input**:
```bash
/tc.refine --apply --level implementation
```

**Terminal Output**:
```
‚ö† WARNING: Over-specification detected

Suite: tc/tests/008-explore-the-strategy/user-story-01/scenario-01
  Forced Level: implementation (manual override)
  Current Level: exploration
  Detected Signals:
    ‚ö† Only 2 passing runs (recommended: 5+ for implementation level)
    ‚ö† Spec unchanged, but test highly refined

  Risk: Test may be too implementation-specific for current development phase.
         This violates language-agnostic principle if technology not finalized.

Recommendations:
  1. Wait for 5+ consecutive passing runs before promoting to implementation
  2. Verify spec still aligns with test intent (run /tc.validate)
  3. Consider keeping at exploration level until technology stable

Proceed with forced level? [y/N]: N

Aborted (maturity level unchanged).
```

### Example 4: Interactive Refinement

**Input**:
```bash
/tc.refine --interactive
```

**Terminal Output**:
```
üîç Analyzing test maturity signals...

Suite: tc/tests/008-explore-the-strategy/user-story-01/scenario-01 [1/3]
  Current: exploration
  Suggested: implementation (5+ passing runs detected)

Promote to implementation level? [Y/n]: Y

Refinement opportunity 1/2:
  Field: user_id
  Current: "<uuid>"
  Suggestion: "550e8400-e29b-41d4-a716-446655440000" (concrete UUID from passing runs)

Apply? [Y/n/s(kip all)]: Y

‚úì Updated user_id to concrete UUID

Refinement opportunity 2/2:
  Field: created_at
  Current: "<timestamp>"
  Suggestion: "<timestamp_recent>" (custom pattern: within 5min)

Apply? [Y/n/s]: n

Skipped created_at (kept as <timestamp>)

‚úì Suite refined: 1 of 2 suggestions applied
‚úì Maturity promoted: exploration ‚Üí implementation

Continue to next suite? [Y/n]: Y
...
```

## Error Handling

### Fatal Errors (Exit 1)

| Error | Condition | Message |
|-------|-----------|---------|
| No tests found | Test directory empty/missing | `ERROR: No tests found in {path}` |
| Corrupted metadata | maturity.json or traceability.json invalid | `ERROR: Corrupted metadata (regenerate with /tc.specify)` |
| Invalid level | --level value not concept/exploration/implementation | `ERROR: Invalid level "{value}" (must be concept/exploration/implementation)` |

### Warnings (Exit 2)

| Warning | Condition | Behavior |
|---------|-----------|----------|
| Over-specification | Too many concrete values at concept level | Warn, suggest staying abstract |
| Spec-test drift | Test refined but spec unchanged | Warn, suggest running /tc.validate |
| Premature promotion | <5 passing runs for implementation level | Warn, require confirmation |

### Edge Cases

| Case | Behavior |
|------|----------|
| No refinements available | Report "no changes suggested", exit 0 |
| Conflicting signals | Prioritize manual override (--level flag) |
| Baseline already exists | Append timestamp to avoid overwrite |

## Maturity Transition Rules

### Concept ‚Üí Exploration

**Auto-detect triggers**:
- Run script modified beyond template (git diff or mtime)
- First passing test execution (tc result shows exit 0)

**Manual override**:
```bash
/tc.refine --level exploration --apply
```

**Preserves**: Original pattern-based tests in `scenario-NN-concept-baseline/`

### Exploration ‚Üí Implementation

**Auto-detect triggers**:
- 5+ consecutive passing test runs (from tc execution logs)
- Pattern usage decreased (more exact values in expected.json)

**Manual override**:
```bash
/tc.refine --level implementation --apply
```

**Preserves**: Exploration-level tests in `scenario-NN-exploration-baseline/`

## Testing Contract

**TC Test Suite**: `tc/tests/tc-kit/tc-kit-refine/`

**Test Scenarios**:
1. **Signal detection**: Modified run script ‚Üí suggest exploration level
2. **Baseline preservation**: Apply refinement ‚Üí original test backed up
3. **Over-specification warning**: Premature refinement ‚Üí warn and block
4. **Interactive mode**: User input ‚Üí apply only selected refinements
5. **Dry run**: --dry-run flag ‚Üí no files modified

## Dependencies

- **tc framework**: For test execution history
- **jq**: For JSON manipulation
- **git** (optional): For commit detection
- **maturity.json**: Existing maturity metadata
- **traceability.json**: Spec-test links

## Performance

**Target**: <5 seconds for maturity analysis of 50 test suites

**Benchmarks**:
- 10 suites: <1 second
- 50 suites: <5 seconds
- 100 suites: <10 seconds

## Related Requirements

- FR-006: Incremental test refinement
- FR-007: Preserve original pattern-based tests
- FR-008: Track maturity levels (concept‚Üíexploration‚Üíimplementation)
- FR-009: Allow custom patterns via TC_CUSTOM_PATTERNS
- FR-010: Generate refactoring suggestions
- SC-005: Incremental progression without rewrites
